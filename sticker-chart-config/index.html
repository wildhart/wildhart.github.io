<!DOCTYPE html>
<html>
  <head>
  <title>Sticker Chart Configuration</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.min.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Sticker Chart Configuration</h1>

    <div class="item-container">
      <div class="item-container-header" id="div-children">Children</div>
      <div class="item-container-content div-child">
        <label class="item">
          <div class="item-input-wrapper item-input-wrapper-button">
            <input type="text" class="item-input child-name" name="child-name-n" placeholder="Child Name">
          </div>
          <input type="button" class="item-button item-input-button delete-child" value="X">
        </label>
      </div>
      <div class="button-container">
        <input type="button" class="item-button" value="New Child" id="new-child">
      </div>
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
      </div>
    </div>

    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" class="center">
    <Br>
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="hosted_button_id" value="P4A5BZRG3SAVL">
    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
    <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
    </form>

    <div class='item-container'>
      <div class="item-container-footer">
        Sticker Chart Version <span id="app-version">x.xx</span><br/>
        by Chris Morison: <a href="mailto:cmorison@gmail.com">cmorison@gmail.com</a>
      </div>
    </div>

  </body>
  <script>

  var $div_child; // used to store the template for each child
  var dataVersion=0;

  function getConfigData() {
 
    var options = {
      'data_version' : dataVersion
    };

    $(".div-child .child-name").each(function(index) {
      options['child_'+index]=encodeURIComponent(this.value+"|"+$(this).data('num-stickers'));
    });
    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }
 
  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  });

  $("#new-child").on('click', function() {
    $new_child = $div_child.clone().appendTo("#div-children");
    var child = new Date().getTime();
    $new_child.find(".child-name").attr("name","child-name-"+child).val("New Child").data("num-stickers",0);
  });

  $("body").on('click', ".delete-child", function(e) { // need to use this binding method since elements do not exist yet
    $(this).closest(".div-child").remove();
  });

  (function() {
    $div_child=$(".div-child").remove();
    
    if (getQueryParam("data_version")) { // Load configuration sent from phone is available in the URI
      dataVersion = getQueryParam("data_version");
      $("#app-version").text(getQueryParam("app_version"));

      var child=0;
      while (getQueryParam("child_"+child)) {
        console.log(child);
        var $new_child = $div_child.clone().appendTo("#div-children");
        var params = getQueryParam("child_"+child).split("|");
        $new_child.find(".child-name").attr("name","child-name-"+child).val(params[0]).data("num-stickers",params[1]);
        child++;
      }
    }

  })();
  </script>
</html>
