<!DOCTYPE html>
<html>
  <head>
  <title>Sticker Chart Configuration</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.min.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  .center {
    text-align:center;
  }
  .feedback {
    color:blue;
  }
  .error {
    color:red;
  }
  .valid {
    color:green;
  }
  .hidden {
    display:none;
  }
  #send-to-watch, #send-to-server {
    cursor:pointer;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Sticker Chart Configuration</h1>

    <div class="item-container">
      <div class="item-container-header" id="div-children">Children</div>
      <div class="item-container-content div-child">
        <label class="item">
          <div class="item-input-wrapper item-input-wrapper-button">
            <input type="text" class="item-input child-name" name="child-name-n" placeholder="Child Name">
          </div>
          <input type="button" class="item-button item-input-button delete-child" value="X">
        </label>
      </div>
      <div class="button-container">
        <input type="button" class="item-button" value="New Child" id="new-child">
      </div>
    </div>

    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" class="center">
    <Br>
    <input type="hidden" name="cmd" value="_s-xclick">
    <input type="hidden" name="hosted_button_id" value="P4A5BZRG3SAVL">
    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
    <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
    </form>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SEND DATA TO WATCH'>
      </div>
    </div>

    <br>
    <hr/>
    
    <div class="item-container">
      <div class="item-container-header" id="div-server">Server Sync</div>
      <div class="item-container-content">
        <div class="item">
          By syncing your sticker chart with our server, you and your partner can share the same sticker chart for your children.
        </div>
        <div class="item-container-footer">
          Note that if one of you adds a sticker while off-line, it will be synced with the server when you next run Sticker Chart while on-line.
          However, if your partner also adds a sticker <em>after</em> you then your sticker will be lost.
        </div>
        <label class="item">
          <div class="item-input-wrapper item-input-wrapper">
            <input type="text" class="item-input" id="username" placeholder="Username">
          </div>
        </label>
        <div class="item-container-footer">
          <span class="feedback"></span><br>
          Can be whatever you want, maybe your email address to ensure it's unique.<br>
          You and your partner use the same username and password.
        </div>
      </div>
      <div class="item-container-content hidden" id="div-password">
        <label class="item">
          <div class="item-input-wrapper item-input-wrapper-button">
            <input type="text" class="item-input" id="password" placeholder="Password">
          </div>
          <input type="button" class="item-button item-input-button" value="Create account" id="add-user">
          <input type="button" class="item-button item-input-button hidden" value="Log in" id="log-in">
        </label>
        <div class="item-container-footer">
          <span class="feedback error"></span>
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class="item-container-footer">
        Sticker Chart Version <span id="app-version">x.xx</span><br/>
        by Chris Morison: <a href="mailto:cmorison@gmail.com">cmorison@gmail.com</a>
      </div>
    </div>

  </body>
  <script>

  var $div_child; // used to store the template for each child
  var dataVersion=0;
  var watchTimestamp=1;
  var sync={
    server:"http://nzmodels/sticker-chart/index.php",
    username:false,
    password:false,
  }
  var request={};
  $username_feedback=$("#username").closest(".item-container-content").find(".feedback");
  $password_feedback=$("#password").closest(".item-container-content").find(".feedback");

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  function valid_request(func, fields) {
    request={}; // Global variable
    request.url=sync.server+"?func="+func;
    request.username=$("#username").val();

    if (request.username.length <5) {
      $username_feedback.text("Username should be at least 5 characters").removeClass("valid");
      $("#div-password").addClass("hidden");
      return false;
    }
    $("#div-password").removeClass("hidden");
    request.url+="&user_id="+encodeURIComponent(request.username);

    if (fields.match("password")) {
      request.password=$("#password").val();
      if (request.password.length <5) {
        $password_feedback.text("Password should be at least 5 characters").removeClass("valid");
        return false;
      }
      request.url+="&password="+encodeURIComponent(request.password);
    }
    if (fields.match("children")) {
      request.children=[];
      $(".div-child .child-name").each(function(index) {
         request.children.push(this.value+"|"+$(this).data('num-stickers')+"|"+$(this).data('stickers'));
      });
      request.url+="&children="+encodeURIComponent(JSON.stringify(request.children));
    }
    if (fields.match("timestamp")) {
      request.url+="&timestamp="+encodeURIComponent(watchTimestamp);
    }
    return true;
  }


  $("#username").on('input', function() {
    if (!valid_request("check_user_exists", "")) return;
    $username_feedback.text("Checking username...");
    sync.username=false;
	$.getJSON(request.url, function(json) {
	  $username_feedback.text(json.success ? "Username exists" : "Username is valid").toggleClass("valid",json.success);
	  sync.username=json.success ? request.username : false;
	  $("#add-user").toggleClass("hidden", json.success);
	  $("#log-in").toggleClass("hidden", !json.success);
	});
  });

  $("#username").val("chris").trigger('input');
  $("#password").val("testp");

  $("#password").on("input", function() {
    if (this.value.length > 4) $(this).closest(".item-container-content").find(".feedback").text("");
  });

  $("#add-user").on("click", function() {
    if (!valid_request("add_user", "password,children,timestamp")) return;
    $password_feedback.text("Adding user...");
    $.getJSON(request.url, function(json) {
      $password_feedback.text(json.success ? "User added, data saved on server" : "Incorrect username or password, or server error").toggleClass("valid",json.success);
	  $("#add-user").toggleClass("hidden", json.success);
	  $("#log-in").toggleClass("hidden", !json.success);
    });
  });

  $("#log-in").on('click', function() {
    log_in_or_send("get_children");
  });

  function log_in_or_send(func) {
    if (!valid_request(func, "password,children,timestamp")) return;
    $password_feedback.text("Checking password...");
    $.getJSON(request.url, function(json) {
      $password_feedback.text(json.success ? "Password correct, logged in" : "Wrong password").toggleClass("valid",json.success);
      if (json.success) {
        sync.username=username;
        sync.password=password;
        var message="";
        if (func == "update_children" || json.success.children == JSON.stringify(request.children)) {
          message="Server data matches watch data, all good!";
        } else {
          var s=json.success.timestamp - watchTimestamp;
          message="<div class='error'>"
                  +(s ? "Watch data is "+(s>0 ? "older":"newer")+" than server data!" :"Watch data is different from server data!")
                  +"<br>Watch data: "+short_msg(request.children)
                  +"<br>Server data: "+short_msg(JSON.parse(json.success.children))
                  +"<br>Option 1: <a id='send-to-server'>Click to send "+(s?(s>0?"old ":"new "):"")+" watch data to server...</a>"
                  +"<br>Option 2: <a id='send-to-watch'>Click to send "+(s?(s>0?"new ":"old "):"")+"server data to watch...</a>"
                  +"</div>";
        }
        request.response=json.success;
        $password_feedback.html($password_feedback.text()+"<br>"+message);
      } 
    });
  }

  function short_msg(children) {
    return $.map(children,function(item,index) {var a=item.split("|"); return a[0]+", "+a[1]+" sticker"+(a[1]>1?"s":"")}).join("; &nbsp; ");
  }
 
  $('body').bind('click', "#send-to-server", function() { log_in_or_send("update_children"); });

  $('body').bind('click', "#send-to-watch", function() {
    watchTimestamp=request.response.timestamp;
    create_child_divs(JSON.parse(request.response.children));
    $("#submit_button").trigger("click");
  });
  
  $("#submit_button").on("click", function() {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  });

  function getConfigData() {
    var options = {
      'data_version' : dataVersion,
      'timestamp' : watchTimestamp
    };

    $(".div-child .child-name").each(function(index) {
      options['child_'+index]=encodeURIComponent(this.value+"|"+$(this).data('num-stickers')+"|"+$(this).data('stickers'));
    });
    console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  $("#new-child").on('click', function() {
    $new_child = $div_child.clone().appendTo("#div-children");
    var child = new Date().getTime();
    $new_child.find(".child-name").attr("name","child-name-"+child).val("New Child").data("num-stickers",0);
  });

  $("body").on('click', ".delete-child", function(e) { // need to use this binding method since elements do not exist yet
    $(this).closest(".div-child").remove();
  });

  function create_child_divs(children) {
    $(".div-child").remove();
    $.each(children, function(child) {
      var $new_child = $div_child.clone().appendTo("#div-children");
      var params = this.split("|");
      $new_child.find(".child-name").attr("name","child-name-"+child).val(params[0]).data("num-stickers",params[1]).data("stickers",params[2]);
    });
  }

  (function() {
    $div_child=$(".div-child").remove();
    
    if (getQueryParam("data_version")) { // Load configuration sent from phone is available in the URI
      dataVersion = getQueryParam("data_version");
      watchTimestamp = getQueryParam("timestamp");
      $("#app-version").text(getQueryParam("app_version"));

      var children=[];
      var child=0;
      while (getQueryParam("child_"+child)) children.push(getQueryParam("child_"+child++));
      create_child_divs(children);
    }

  })();
  </script>
</html>
